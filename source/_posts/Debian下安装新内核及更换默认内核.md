title: Debian下安装新内核及更换默认内核
author: Creling
tags: []
categories:
  - Linux
toc: 'true'
date: 2019-12-13 00:13:00
---
**摘要** 介绍了Debian下安装新内核及更换默认内核的方法

<!--more-->

## 安装新内核
```bash
dpkg -i *deb
```

## 修改默认内核
1. 查看当前启动菜单

  ```ini /boot/grub/grub.cfg
  #
  # DO NOT EDIT THIS FILE
  #
  # It is automatically generated by grub-mkconfig using templates
  # from /etc/grub.d and settings from /etc/default/grub
  #

  ### BEGIN /etc/grub.d/00_header ###
  if [ -s $prefix/grubenv ]; then
    set have_grubenv=true
    load_env
  fi
  if [ "${next_entry}" ] ; then
     set default="${next_entry}"
     set next_entry=
     save_env next_entry
     set boot_once=true
  else
     set default="Advanced options for Debian GNU/Linux>Debian GNU/Linux, with Linux 4.14.129-bbrplus"
  fi

  if [ x"${feature_menuentry_id}" = xy ]; then
    menuentry_id_option="--id"
  else
    menuentry_id_option=""
  fi

  export menuentry_id_option

  if [ "${prev_saved_entry}" ]; then
    set saved_entry="${prev_saved_entry}"
    save_env saved_entry
    set prev_saved_entry=
    save_env prev_saved_entry
    set boot_once=true
  fi

  function savedefault {
    if [ -z "${boot_once}" ]; then
      saved_entry="${chosen}"
      save_env saved_entry
    fi
  }
  function load_video {
    if [ x$feature_all_video_module = xy ]; then
      insmod all_video
    else
      insmod efi_gop
      insmod efi_uga
      insmod ieee1275_fb
      insmod vbe
      insmod vga
      insmod video_bochs
      insmod video_cirrus
    fi
  }

  if [ x$feature_default_font_path = xy ] ; then
     font=unicode
  else
  insmod part_msdos
  insmod ext2
  if [ x$feature_platform_search_hint = xy ]; then
    search --no-floppy --fs-uuid --set=root  027db92b-683c-47c8-8767-e1fc16ee6df7
  else
    search --no-floppy --fs-uuid --set=root 027db92b-683c-47c8-8767-e1fc16ee6df7
  fi
      font="/usr/share/grub/unicode.pf2"
  fi

  if loadfont $font ; then
    set gfxmode=auto
    load_video
    insmod gfxterm
    set locale_dir=$prefix/locale
    set lang=en_US
    insmod gettext
  fi
  terminal_output gfxterm
  if [ "${recordfail}" = 1 ] ; then
    set timeout=30
  else
    if [ x$feature_timeout_style = xy ] ; then
      set timeout_style=menu
      set timeout=5
    # Fallback normal timeout code in case the timeout_style feature is
    # unavailable.
    else
      set timeout=5
    fi
  fi
  ### END /etc/grub.d/00_header ###

  ### BEGIN /etc/grub.d/05_debian_theme ###
  set menu_color_normal=cyan/blue
  set menu_color_highlight=white/blue
  ### END /etc/grub.d/05_debian_theme ###

  ### BEGIN /etc/grub.d/10_linux ###
  function gfxmode {
          set gfxpayload="${1}"
  }
  set linux_gfx_mode=
  export linux_gfx_mode
  menuentry 'Debian GNU/Linux' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-027db92b-683c-47c8-8767-e1fc16ee6df7' {
          load_video
          insmod gzio
          if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
          insmod part_msdos
          insmod ext2
          if [ x$feature_platform_search_hint = xy ]; then
            search --no-floppy --fs-uuid --set=root  f9cae74d-6fc8-47c0-be89-00a237271167
          else
            search --no-floppy --fs-uuid --set=root f9cae74d-6fc8-47c0-be89-00a237271167
          fi
          echo    'Loading Linux 4.14.129-bbrplus ...'
          linux   /vmlinuz-4.14.129-bbrplus root=UUID=027db92b-683c-47c8-8767-e1fc16ee6df7 ro  quiet
          echo    'Loading initial ramdisk ...'
          initrd  /initrd.img-4.14.129-bbrplus
  }
  submenu 'Advanced options for Debian GNU/Linux' $menuentry_id_option 'gnulinux-advanced-027db92b-683c-47c8-8767-e1fc16ee6df7' {
          menuentry 'Debian GNU/Linux, with Linux 4.14.129-bbrplus' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.14.129-bbrplus-advanced-027db92b-683c-47c8-8767-e1fc16ee6df7' {
                  load_video
                  insmod gzio
                  if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
                  insmod part_msdos
                  insmod ext2
                  if [ x$feature_platform_search_hint = xy ]; then
                    search --no-floppy --fs-uuid --set=root  f9cae74d-6fc8-47c0-be89-00a237271167
                  else
                    search --no-floppy --fs-uuid --set=root f9cae74d-6fc8-47c0-be89-00a237271167
                  fi
                  echo    'Loading Linux 4.14.129-bbrplus ...'
                  linux   /vmlinuz-4.14.129-bbrplus root=UUID=027db92b-683c-47c8-8767-e1fc16ee6df7 ro  quiet
                  echo    'Loading initial ramdisk ...'
                  initrd  /initrd.img-4.14.129-bbrplus
          }
          menuentry 'Debian GNU/Linux, with Linux 4.14.129-bbrplus (recovery mode)' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.14.129-bbrplus-recovery-027db92b-683c-47c8-8767-e1fc16ee6df7' {
                  load_video
                  insmod gzio
                  if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
                  insmod part_msdos
                  insmod ext2
                  if [ x$feature_platform_search_hint = xy ]; then
                    search --no-floppy --fs-uuid --set=root  f9cae74d-6fc8-47c0-be89-00a237271167
                  else
                    search --no-floppy --fs-uuid --set=root f9cae74d-6fc8-47c0-be89-00a237271167
                  fi
                  echo    'Loading Linux 4.14.129-bbrplus ...'
                  linux   /vmlinuz-4.14.129-bbrplus root=UUID=027db92b-683c-47c8-8767-e1fc16ee6df7 ro single
                  echo    'Loading initial ramdisk ...'
                  initrd  /initrd.img-4.14.129-bbrplus
          }
          menuentry 'Debian GNU/Linux, with Linux 4.9.0-8-amd64' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.9.0-8-amd64-advanced-027db92b-683c-47c8-8767-e1fc16ee6df7' {
                  load_video
                  insmod gzio
                  if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
                  insmod part_msdos
                  insmod ext2
                  if [ x$feature_platform_search_hint = xy ]; then
                    search --no-floppy --fs-uuid --set=root  f9cae74d-6fc8-47c0-be89-00a237271167
                  else
                    search --no-floppy --fs-uuid --set=root f9cae74d-6fc8-47c0-be89-00a237271167
                  fi
                  echo    'Loading Linux 4.9.0-8-amd64 ...'
                  linux   /vmlinuz-4.9.0-8-amd64 root=UUID=027db92b-683c-47c8-8767-e1fc16ee6df7 ro  quiet
                  echo    'Loading initial ramdisk ...'
                  initrd  /initrd.img-4.9.0-8-amd64
          }
          menuentry 'Debian GNU/Linux, with Linux 4.9.0-8-amd64 (recovery mode)' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.9.0-8-amd64-recovery-027db92b-683c-47c8-8767-e1fc16ee6df7' {
                  load_video
                  insmod gzio
                  if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
                  insmod part_msdos
                  insmod ext2
                  if [ x$feature_platform_search_hint = xy ]; then
                    search --no-floppy --fs-uuid --set=root  f9cae74d-6fc8-47c0-be89-00a237271167
                  else
                    search --no-floppy --fs-uuid --set=root f9cae74d-6fc8-47c0-be89-00a237271167
                  fi
                  echo    'Loading Linux 4.9.0-8-amd64 ...'
                  linux   /vmlinuz-4.9.0-8-amd64 root=UUID=027db92b-683c-47c8-8767-e1fc16ee6df7 ro single
                  echo    'Loading initial ramdisk ...'
                  initrd  /initrd.img-4.9.0-8-amd64
          }
  }

  ### END /etc/grub.d/10_linux ###

  ### BEGIN /etc/grub.d/20_linux_xen ###

  ### END /etc/grub.d/20_linux_xen ###

  ### BEGIN /etc/grub.d/30_os-prober ###
  ### END /etc/grub.d/30_os-prober ###

  ### BEGIN /etc/grub.d/30_uefi-firmware ###
  ### END /etc/grub.d/30_uefi-firmware ###

  ### BEGIN /etc/grub.d/40_custom ###
  # This file provides an easy way to add custom menu entries.  Simply type the
  # menu entries you want to add after this comment.  Be careful not to change
  # the 'exec tail' line above.
  ### END /etc/grub.d/40_custom ###

  ### BEGIN /etc/grub.d/41_custom ###
  if [ -f  ${config_directory}/custom.cfg ]; then
    source ${config_directory}/custom.cfg
  elif [ -z "${config_directory}" -a -f  $prefix/custom.cfg ]; then
    source $prefix/custom.cfg;
  fi
  ### END /etc/grub.d/41_custom ###
  ```
  这其实是一个树结构，包含了`menuentry`，`submenu`等项，而我们的目标就是将我们的新内核变成默认的启动项。为此，我们需要修改启动菜单模板。
  
2. 修改启动菜单模板
```bash /etc/default/grub 
GRUB_DEFAULT=0 修改为
GRUB_DEFAULT="Advanced options for Debian GNU/Linux>Debian GNU/Linux, with Linux 4.14.129-bbrplus"
```
其中`Advanced options for Debian GNU/Linux`是一级菜单,`Debian GNU/Linux, with Linux 4.14.129-bbrplus`是二级菜单, 中间用`>`连接.

3. 生成新的启动菜单文件
```bash
update-grub
```

4. 重启系统
